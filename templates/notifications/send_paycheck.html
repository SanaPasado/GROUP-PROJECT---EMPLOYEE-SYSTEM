{% extends 'base.html' %}
{% block title %}<title>Send Paycheck Notification</title>{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <!-- Left Side: Form -->
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h3 class="card-title mb-0">
                        <i class="bi bi-cash-stack"></i> Send Paycheck Notification
                    </h3>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="{{ form.employee.id_for_label }}" class="form-label">
                                <i class="bi bi-person"></i> Select Employee *
                            </label>
                            {{ form.employee }}
                            {% if form.employee.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.employee.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.amount.id_for_label }}" class="form-label">
                                <i class="bi bi-currency-dollar"></i> Paycheck Amount *
                            </label>
                            {{ form.amount }}
                            {% if form.amount.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.amount.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">Enter the paycheck amount in PHP</small>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.message.id_for_label }}" class="form-label">
                                <i class="bi bi-chat-text"></i> Message
                            </label>
                            {{ form.message }}
                            {% if form.message.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.message.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">Add a personalized message (optional)</small>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-send"></i> Send
                            </button>
                            <a href="{% url 'notifications:paycheck_dashboard' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Dashboard
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Side: Employee Calculation Panel -->
        <div class="col-md-6">
            <div class="card shadow" id="calculation-panel" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-calculator"></i> Payroll Calculation
                    </h5>
                </div>
                <div class="card-body">
                    <div id="employee-info">
                        <div class="text-center mb-3">
                            <img id="employee-photo" src="" class="rounded-circle" width="60" height="60" alt="Employee Photo" style="display: none;">
                            <div id="employee-placeholder" class="bg-secondary rounded-circle d-flex align-items-center justify-content-center mx-auto"
                                 style="width: 60px; height: 60px; display: none;">
                                <i class="bi bi-person text-white"></i>
                            </div>
                            <h6 id="employee-name" class="mt-2 mb-0"></h6>
                            <small id="employee-position" class="text-muted"></small>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tr>
                                    <th>Department:</th>
                                    <td id="employee-department">-</td>
                                </tr>
                                <tr>
                                    <th>Hourly Rate:</th>
                                    <td id="employee-hourly-rate">₱-</td>
                                </tr>
                                <tr>
                                    <th>Hours This Week:</th>
                                    <td id="employee-weekly-hours">- hours</td>
                                </tr>
                                <tr>
                                    <th>Regular Pay:</th>
                                    <td id="employee-regular-pay">₱-</td>
                                </tr>
                                <tr>
                                    <th>Overtime Hours:</th>
                                    <td id="employee-overtime-hours">- hours</td>
                                </tr>
                                <tr>
                                    <th>Overtime Pay:</th>
                                    <td id="employee-overtime-pay">₱-</td>
                                </tr>
                                <tr class="table-success">
                                    <th><strong>Total Earnings:</strong></th>
                                    <td><strong id="employee-total-earnings">₱-</strong></td>
                                </tr>
                            </table>
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="auto-fill-amount">
                                <i class="bi bi-magic"></i> Use Calculated Amount
                            </button>
                        </div>
                    </div>

                    <div id="loading-state" style="display: none;">
                        <div class="text-center">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Calculating payroll...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const employeeSelect = document.getElementById('{{ form.employee.id_for_label }}');
    const calculationPanel = document.getElementById('calculation-panel');
    const amountInput = document.getElementById('{{ form.amount.id_for_label }}');
    const autoFillBtn = document.getElementById('auto-fill-amount');
    const loadingState = document.getElementById('loading-state');
    const employeeInfo = document.getElementById('employee-info');

    let selectedEmployeeData = null;

    // Add Bootstrap classes to form fields
    employeeSelect.classList.add('form-select');
    amountInput.classList.add('form-control');
    amountInput.setAttribute('step', '0.01');
    amountInput.setAttribute('placeholder', '0.00');
    document.getElementById('{{ form.message.id_for_label }}').classList.add('form-control');

    employeeSelect.addEventListener('change', function() {
        const employeeId = this.value;

        if (employeeId) {
            // Show calculation panel with loading state
            calculationPanel.style.display = 'block';
            loadingState.style.display = 'block';
            employeeInfo.style.display = 'none';

            // Simulate fetching employee data (replace with actual AJAX call)
            setTimeout(() => {
                // This would be replaced with actual employee data from your backend
                const mockData = {
                    id: employeeId,
                    name: employeeSelect.options[employeeSelect.selectedIndex].text,
                    position: 'Software Developer',
                    department: 'IT Department',
                    photo: null,
                    hourly_rate: '250.00',
                    weekly_hours: 40,
                    regular_hours: 40,
                    overtime_hours: 0,
                    regular_pay: '10000.00',
                    overtime_pay: '0.00',
                    total_earnings: '10000.00'
                };

                selectedEmployeeData = mockData;
                updateCalculationPanel(mockData);
                loadingState.style.display = 'none';
                employeeInfo.style.display = 'block';
            }, 1000);

        } else {
            calculationPanel.style.display = 'none';
            selectedEmployeeData = null;
        }
    });

    autoFillBtn.addEventListener('click', function() {
        if (selectedEmployeeData && selectedEmployeeData.total_earnings) {
            amountInput.value = selectedEmployeeData.total_earnings;
            amountInput.focus();
        }
    });

    function updateCalculationPanel(data) {
        // Update employee info
        document.getElementById('employee-name').textContent = data.name || 'Unknown Employee';
        document.getElementById('employee-position').textContent = data.position || '';
        document.getElementById('employee-department').textContent = data.department || '-';

        // Update photo or show placeholder
        const photo = document.getElementById('employee-photo');
        const placeholder = document.getElementById('employee-placeholder');
        if (data.photo) {
            photo.src = data.photo;
            photo.style.display = 'block';
            placeholder.style.display = 'none';
        } else {
            photo.style.display = 'none';
            placeholder.style.display = 'flex';
        }

        // Update calculation details
        document.getElementById('employee-hourly-rate').textContent = `₱${data.hourly_rate || '0.00'}`;
        document.getElementById('employee-weekly-hours').textContent = `${data.weekly_hours || '0'} hours`;
        document.getElementById('employee-regular-pay').textContent = `₱${data.regular_pay || '0.00'}`;
        document.getElementById('employee-overtime-hours').textContent = `${data.overtime_hours || '0'} hours`;
        document.getElementById('employee-overtime-pay').textContent = `₱${data.overtime_pay || '0.00'}`;
        document.getElementById('employee-total-earnings').textContent = `₱${data.total_earnings || '0.00'}`;
    }
});
</script>
{% endblock %}
