{% extends 'base.html' %}
{% block title %}<title>Send Paycheck Notification</title>{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <!-- Left Side: Form -->
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h3 class="card-title mb-0">
                        <i class="bi bi-cash-stack"></i> Send Paycheck Notification
                    </h3>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="{{ form.employee.id_for_label }}" class="form-label">
                                <i class="bi bi-person"></i> Select Employee *
                            </label>
                            {{ form.employee }}
                            {% if form.employee.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.employee.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.amount.id_for_label }}" class="form-label">
                                <i class="bi bi-currency-dollar"></i> Paycheck Amount *
                            </label>
                            {{ form.amount }}
                            {% if form.amount.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.amount.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">Enter the paycheck amount in PHP</small>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.message.id_for_label }}" class="form-label">
                                <i class="bi bi-chat-text"></i> Message
                            </label>
                            {{ form.message }}
                            {% if form.message.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.message.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">Add a personalized message (optional)</small>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-send"></i> Send
                            </button>
                            <a href="{% url 'notifications:paycheck_dashboard' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Dashboard
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Side: Employee Calculation Panel -->
        <div class="col-md-6">
            <div class="card shadow" id="calculation-panel" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-calculator"></i> Payroll Calculation
                    </h5>
                </div>
                <div class="card-body">
                    <div id="employee-info">
                        <div class="text-center mb-3">
                            <img id="employee-photo" src="" class="rounded-circle" width="60" height="60" alt="Employee Photo" style="display: none;">
                            <div id="employee-placeholder" class="bg-secondary rounded-circle d-flex align-items-center justify-content-center mx-auto"
                                 style="width: 60px; height: 60px; display: none;">
                                <i class="bi bi-person text-white"></i>
                            </div>
                            <h6 id="employee-name" class="mt-2 mb-0"></h6>
                            <small id="employee-position" class="text-muted"></small>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tr>
                                    <th>Department:</th>
                                    <td id="employee-department">-</td>
                                </tr>
                                <tr>
                                    <th>Hourly Rate:</th>
                                    <td id="employee-hourly-rate">₱-</td>
                                </tr>
                                <tr>
                                    <th>Hours This Week:</th>
                                    <td id="employee-weekly-hours">- hours</td>
                                </tr>
                                <tr>
                                    <th>Regular Pay:</th>
                                    <td id="employee-regular-pay">₱-</td>
                                </tr>
                                <tr>
                                    <th>Overtime Hours:</th>
                                    <td>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span id="employee-overtime-hours">- hours</span>
                                            <div id="overtime-approval-section" style="display: none;">
                                                <div class="btn-group btn-group-sm me-2" role="group" id="overtime-buttons">
                                                    <button type="button" class="btn btn-success btn-sm approve-overtime-btn" id="approve-overtime-btn">
                                                        <i class="bi bi-check-circle"></i> Approve
                                                    </button>
                                                    <button type="button" class="btn btn-danger btn-sm reject-overtime-btn" id="reject-overtime-btn">
                                                        <i class="bi bi-x-circle"></i> Reject
                                                    </button>
                                                </div>
                                                <div id="overtime-status"></div>
                                            </div>
                                        </div>
                                        <div id="overtime-details" class="mt-1" style="display: none;">
                                            <small class="text-muted">
                                                <span id="pending-overtime-text"></span>
                                                <span id="unapproved-overtime-text"></span>
                                            </small>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Overtime Pay:</th>
                                    <td id="employee-overtime-pay">₱-</td>
                                </tr>
                                <tr class="table-success">
                                    <th><strong>Total Earnings:</strong></th>
                                    <td><strong id="employee-total-earnings">₱-</strong></td>
                                </tr>
                            </table>
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="auto-fill-amount">
                                <i class="bi bi-magic"></i> Use Calculated Amount
                            </button>
                        </div>
                    </div>

                    <div id="loading-state" style="display: none;">
                        <div class="text-center">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Calculating payroll...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const employeeSelect = document.getElementById('{{ form.employee.id_for_label }}');
    const calculationPanel = document.getElementById('calculation-panel');
    const amountInput = document.getElementById('{{ form.amount.id_for_label }}');
    const autoFillBtn = document.getElementById('auto-fill-amount');
    const loadingState = document.getElementById('loading-state');
    const employeeInfo = document.getElementById('employee-info');

    let selectedEmployeeData = null;

    // Add Bootstrap classes to form fields
    employeeSelect.classList.add('form-select');
    amountInput.classList.add('form-control');
    amountInput.setAttribute('step', '0.01');
    amountInput.setAttribute('placeholder', '0.00');
    document.getElementById('{{ form.message.id_for_label }}').classList.add('form-control');

    employeeSelect.addEventListener('change', function() {
        const employeeId = this.value;

        if (employeeId) {
            // Show calculation panel with loading state
            calculationPanel.style.display = 'block';
            loadingState.style.display = 'block';
            employeeInfo.style.display = 'none';

            // Fetch real employee payroll data via AJAX
            fetch(`/notifications/ajax/employee/${employeeId}/payroll/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch employee data');
                    }
                    return response.json();
                })
                .then(data => {
                    selectedEmployeeData = data;
                    updateCalculationPanel(data);
                    loadingState.style.display = 'none';
                    employeeInfo.style.display = 'block';

                    // Show warnings if applicable
                    showPayrollWarnings(data);
                })
                .catch(error => {
                    console.error('Error fetching employee data:', error);
                    loadingState.style.display = 'none';
                    showError('Failed to load employee payroll data. Please try again.');
                });

        } else {
            calculationPanel.style.display = 'none';
            selectedEmployeeData = null;
            clearWarnings();
        }
    });

    autoFillBtn.addEventListener('click', function() {
        if (selectedEmployeeData && selectedEmployeeData.total_earnings) {
            amountInput.value = selectedEmployeeData.total_earnings;
            amountInput.focus();
        }
    });

    function updateCalculationPanel(data) {
        // Update employee info
        document.getElementById('employee-name').textContent = data.name || 'Unknown Employee';
        document.getElementById('employee-position').textContent = data.position || '';
        document.getElementById('employee-department').textContent = data.department || '-';

        // Update photo or show placeholder
        const photo = document.getElementById('employee-photo');
        const placeholder = document.getElementById('employee-placeholder');
        if (data.photo) {
            photo.src = data.photo;
            photo.style.display = 'block';
            placeholder.style.display = 'none';
        } else {
            photo.style.display = 'none';
            placeholder.style.display = 'flex';
        }

        // Update calculation details
        document.getElementById('employee-hourly-rate').textContent = `₱${data.hourly_rate || '0.00'}`;
        document.getElementById('employee-weekly-hours').textContent = `${data.weekly_hours || '0'} hours`;
        document.getElementById('employee-regular-pay').textContent = `₱${data.regular_pay || '0.00'}`;
        document.getElementById('employee-overtime-pay').textContent = `₱${data.overtime_pay || '0.00'}`;
        document.getElementById('employee-total-earnings').textContent = `₱${data.total_earnings || '0.00'}`;

        // Show or hide overtime approval section
        const overtimeApprovalSection = document.getElementById('overtime-approval-section');
        const overtimeDetails = document.getElementById('overtime-details');

        console.log('Employee data:', data);
        console.log('Pending overtime hours:', data.pending_overtime_hours);
        console.log('Total overtime hours:', data.total_overtime_hours);
        console.log('Paycheck already sent:', data.paycheck_already_sent);

        // Show buttons if there are any overtime hours and no paycheck sent yet
        if (data.total_overtime_hours > 0 && !data.paycheck_already_sent) {
            overtimeApprovalSection.style.display = 'flex';
            overtimeDetails.style.display = 'block';

            if (data.pending_overtime_hours > 0) {
                document.getElementById('pending-overtime-text').textContent = `${data.pending_overtime_hours} overtime hours pending approval. `;
                document.getElementById('unapproved-overtime-text').textContent = data.unapproved_overtime_hours > 0 ? `${data.unapproved_overtime_hours} overtime hours not approved.` : '';
            } else {
                document.getElementById('pending-overtime-text').textContent = `${data.total_overtime_hours} total overtime hours worked. `;
                document.getElementById('unapproved-overtime-text').textContent = 'Click approve/reject to set overtime status.';
            }
        }
        else {
            overtimeApprovalSection.style.display = 'none';
            overtimeDetails.style.display = 'none';
        }

        // Update overtime hours display to show correct status
        const totalOvertimeHours = (data.total_overtime_hours || 0);
        const approvedOvertimeHours = (data.overtime_hours || 0);
        const pendingOvertimeHours = (data.pending_overtime_hours || 0);

        if (totalOvertimeHours > 0) {
            let overtimeText = `${approvedOvertimeHours} hours approved`;
            if (pendingOvertimeHours > 0) {
                overtimeText += ` (${pendingOvertimeHours} pending)`;
            }
            document.getElementById('employee-overtime-hours').textContent = overtimeText;
        } else {
            document.getElementById('employee-overtime-hours').textContent = '0 hours';
        }
    }

    function showPayrollWarnings(data) {
        clearWarnings();
        const warningsContainer = getOrCreateWarningsContainer();

        // Check if paycheck already sent
        if (data.paycheck_already_sent) {
            showWarning('A paycheck has already been sent for this period (' +
                       data.period_start + ' to ' + data.period_end + ')', 'warning');
        }

        // Check for pending overtime
        if (data.has_pending_overtime && data.pending_overtime_hours > 0) {
            showWarning(`${data.pending_overtime_hours} overtime hours are pending approval. ` +
                       'Only approved overtime is included in the calculation.', 'info');
        }

        // Check for unapproved overtime
        if (data.unapproved_overtime_hours > 0) {
            showWarning(`${data.unapproved_overtime_hours} overtime hours were not approved ` +
                       'and are excluded from this paycheck.', 'secondary');
        }
    }

    function showWarning(message, type = 'warning') {
        const warningsContainer = getOrCreateWarningsContainer();
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <i class="bi bi-exclamation-triangle-fill"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        warningsContainer.appendChild(alertDiv);
    }

    function showError(message) {
        const warningsContainer = getOrCreateWarningsContainer();
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            <i class="bi bi-exclamation-circle-fill"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        warningsContainer.appendChild(alertDiv);
    }

    function getOrCreateWarningsContainer() {
        let container = document.getElementById('warnings-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'warnings-container';
            container.className = 'mb-3';
            calculationPanel.insertBefore(container, calculationPanel.firstChild.nextSibling);
        }
        return container;
    }

    function clearWarnings() {
        const container = document.getElementById('warnings-container');
        if (container) {
            container.innerHTML = '';
        }
    }

    // Handle overtime approval buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('approve-overtime-btn') || e.target.closest('.approve-overtime-btn')) {
            handleOvertimeApproval('approve');
        } else if (e.target.classList.contains('reject-overtime-btn') || e.target.closest('.reject-overtime-btn')) {
            handleOvertimeApproval('reject');
        }
    });

    function handleOvertimeApproval(action) {
        if (!selectedEmployeeData) return;

        const employeeId = selectedEmployeeData.id;
        const actionText = action === 'approve' ? 'approve' : 'reject';
        const actionPastTense = action === 'approve' ? 'approved' : 'rejected';

        if (confirm(`Are you sure you want to ${actionText} overtime hours for ${selectedEmployeeData.name}?`)) {
            // Disable buttons during processing
            const approveBtn = document.getElementById('approve-overtime-btn');
            const rejectBtn = document.getElementById('reject-overtime-btn');
            const statusDiv = document.getElementById('overtime-status');

            approveBtn.disabled = true;
            rejectBtn.disabled = true;
            statusDiv.innerHTML = `<small class="text-muted">Processing...</small>`;

            // Make AJAX call to approve/reject overtime
            fetch(`/notifications/ajax/employee/${employeeId}/overtime/${action}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    period_start: selectedEmployeeData.period_start,
                    period_end: selectedEmployeeData.period_end
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update the status display
                    const badgeClass = action === 'approve' ? 'bg-success' : 'bg-danger';
                    statusDiv.innerHTML = `<small><span class="badge ${badgeClass}">${actionPastTense.toUpperCase()}</span></small>`;

                    // Hide the buttons since action is complete
                    document.getElementById('overtime-buttons').style.display = 'none';

                    // Refresh the payroll data to show updated calculations
                    setTimeout(() => {
                        fetch(`/notifications/ajax/employee/${employeeId}/payroll/`)
                            .then(response => response.json())
                            .then(updatedData => {
                                selectedEmployeeData = updatedData;
                                updateCalculationPanel(updatedData);
                                showPayrollWarnings(updatedData);
                            });
                    }, 500);

                    showSuccess(`Overtime hours ${actionPastTense} successfully! Payroll updated.`);
                } else {
                    showError(data.message || `Failed to ${actionText} overtime hours.`);
                    // Re-enable buttons on error
                    approveBtn.disabled = false;
                    rejectBtn.disabled = false;
                    statusDiv.innerHTML = '';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError(`Failed to ${actionText} overtime hours. Please try again.`);
                // Re-enable buttons on error
                approveBtn.disabled = false;
                rejectBtn.disabled = false;
                statusDiv.innerHTML = '';
            });
        }
    }

    function showSuccess(message) {
        const warningsContainer = getOrCreateWarningsContainer();
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
            <i class="bi bi-check-circle-fill"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        warningsContainer.appendChild(alertDiv);

        // Auto-remove success message after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
});
</script>
{% endblock %}
